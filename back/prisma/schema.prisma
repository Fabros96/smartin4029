generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  imagen    String?
  username  String    @unique
  password  String
  nombre    String
  apellido  String
  rol       Rol       @default(alumno)
  fechaBaja DateTime? @default(now())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  preferenciaNotif Int @default(0)

  reservas       Reserva[]
  tickets        Ticket[]
  sugerencias    Sugerencia[]
  instalaciones  Instalacion[]
  notificaciones Notificacion[]
  historiales    Historial[]

  // Relaciones con cursos
  cursoId   Int?     // Para Alumno: un solo curso
  curso     Curso?   @relation(fields: [cursoId], references: [id])

  cursosProfesor Curso[] @relation("ProfesorCursos") // Para Profesor: varios cursos
}

model Curso {
  id        Int       @id @default(autoincrement())
  nombre    String
  descripcion String?

  alumnos   Usuario[] @relation(fields: [], references: []) // Alumno ↔ Curso (uno a muchos)
  profesores Usuario[] @relation("ProfesorCursos")         // Profesor ↔ Curso (uno a muchos)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model Equipo {
  id        Int           @id @default(autoincrement())
  nombre    String
  imagen    String?
  estado    EstadoRecurso @default(disponible)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  reservas      Reserva[]
  instalaciones Instalacion[]
  historiales   Historial[]   @relation("HistorialEquipo")
}

model Aula {
  id        Int           @id @default(autoincrement())
  nombre    String
  incidente String?
  estado    EstadoRecurso @default(disponible)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  reservas      Reserva[]
  instalaciones Instalacion[]
  historiales   Historial[]   @relation("HistorialSala")
}

model Reserva {
  id          Int           @id @default(autoincrement())
  tipo        ReservaTipo
  estado      EstadoReserva @default(pendiente)
  usuarioId   Int
  equipoId    Int?
  aulaId      Int?
  createdAt   DateTime      @default(now())
  scheduledAt DateTime?

  usuario Usuario @relation(fields: [usuarioId], references: [id])
  equipo  Equipo? @relation(fields: [equipoId], references: [id])
  aula    Aula?   @relation(fields: [aulaId], references: [id])

  historiales Historial[] @relation("HistorialReserva")
}

model Sugerencia {
  id          Int           @id @default(autoincrement())
  titulo      String
  descripcion String
  estado      EstadoGeneral @default(pendiente)
  usuarioId   Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  usuario     Usuario     @relation(fields: [usuarioId], references: [id])
  historiales Historial[] @relation("HistorialSugerencia")
}

model Ticket {
  id          Int          @id @default(autoincrement())
  descripcion String
  imagen      String?
  estado      EstadoTicket @default(pendiente)
  numero      String       @unique
  usuarioId   Int
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  usuario     Usuario     @relation(fields: [usuarioId], references: [id])
  historiales Historial[] @relation("HistorialTicket")
}

model Instalacion {
  id          Int               @id @default(autoincrement())
  aplicacion  String
  descripcion String?
  estado      EstadoInstalacion @default(pendiente)
  usuarioId   Int
  equipoId    Int?
  aulaId      Int?

  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  equipo    Equipo?  @relation(fields: [equipoId], references: [id])
  aula      Aula?    @relation(fields: [aulaId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  historiales Historial[] @relation("HistorialInstalacion")
}

model Notificacion {
  id        Int     @id @default(autoincrement())
  mensaje   String
  leida     Boolean @default(false)
  usuarioId Int

  usuario   Usuario  @relation(fields: [usuarioId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Historial {
  id          Int      @id @default(autoincrement())
  estadoViejo String?
  estadoNuevo String?
  fechaCambio DateTime @default(now())

  usuarioResponsable Int?
  usuario            Usuario? @relation(fields: [usuarioResponsable], references: [id], map: "fk_historial_usuario")

  equipoId      Int?
  aulaId        Int?
  reservaId     Int?
  sugerenciaId  Int?
  ticketId      Int?
  instalacionId Int?

  equipo Equipo? @relation("HistorialEquipo", fields: [equipoId], references: [id], map: "fk_historial_equipo")

  aula Aula? @relation("HistorialSala", fields: [aulaId], references: [id], map: "fk_historial_aula")

  reserva Reserva? @relation("HistorialReserva", fields: [reservaId], references: [id], map: "fk_historial_reserva")

  sugerencia Sugerencia? @relation("HistorialSugerencia", fields: [sugerenciaId], references: [id], map: "fk_historial_sugerencia")

  ticket Ticket? @relation("HistorialTicket", fields: [ticketId], references: [id], map: "fk_historial_ticket")

  instalacion Instalacion? @relation("HistorialInstalacion", fields: [instalacionId], references: [id], map: "fk_historial_instalacion")
}

enum EstadoGeneral {
  pendiente
  aceptado
  rechazado
  cancelado
}

enum EstadoRecurso {
  disponible
  ocupado
  mantenimiento
}

enum Rol {
  alumno
  profesor
  preceptor
  especial
  admin
}

enum ReservaTipo {
  inmediata
  programada
}

enum EstadoReserva {
  pendiente
  aprobada
  rechazada
  cancelada
  completada
}

enum EstadoTicket {
  pendiente
  aceptado
  rechazado
  cancelado
}

enum EstadoInstalacion {
  pendiente
  asignada
  completada
  cancelada
}
